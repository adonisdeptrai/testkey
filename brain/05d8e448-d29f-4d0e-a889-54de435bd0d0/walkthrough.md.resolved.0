# Google OAuth Integration - Setup & Testing Guide

T√≠ch h·ª£p Google OAuth v·ªõi Supabase ƒë√£ ho√†n th√†nh. D∆∞·ªõi ƒë√¢y l√† h∆∞·ªõng d·∫´n setup v√† testing.

---

## ‚úÖ ƒê√£ Ho√†n Th√†nh

### Backend Changes

- [supabase.js](file:///c:/Users/Adonis/Downloads/App/server/config/supabase.js) - Th√™m anon client cho OAuth
- [oauth.js](file:///c:/Users/Adonis/Downloads/App/server/routes/oauth.js) - **NEW** OAuth callback routes
- [010_add_google_oauth_support.sql](file:///c:/Users/Adonis/Downloads/App/server/supabase/migrations/010_add_google_oauth_support.sql) - **NEW** Database migration
- Updated 11 route files ƒë·ªÉ s·ª≠ d·ª•ng destructured import

### Frontend Changes

- [supabase.ts](file:///c:/Users/Adonis/Downloads/App/src/config/supabase.ts) - **NEW** Frontend Supabase client
- [AuthContext.tsx](file:///c:/Users/Adonis/Downloads/App/src/contexts/AuthContext.tsx) - Th√™m [loginWithGoogle()](file:///c:/Users/Adonis/Downloads/App/src/contexts/AuthContext.tsx#74-96) method
- [Auth.tsx](file:///c:/Users/Adonis/Downloads/App/src/pages/Auth.tsx) - K·∫øt n·ªëi Google button v·ªõi OAuth flow
- [AuthCallback.tsx](file:///c:/Users/Adonis/Downloads/App/src/pages/AuthCallback.tsx) - **NEW** Callback handler page
- [App.tsx](file:///c:/Users/Adonis/Downloads/App/src/App.tsx) - Th√™m `/auth/callback` route

### Configuration

- [.env](file:///c:/Users/Adonis/Downloads/App/.env) - Added `SUPABASE_ANON_KEY`
- [.env.local](file:///c:/Users/Adonis/Downloads/App/.env.local) - **NEW** Frontend environment variables

---

## üöÄ Setup Guide (C·∫ßn User Th·ª±c Hi·ªán)

### Phase 1: Supabase Dashboard Configuration

1. **V√†o Supabase Dashboard**  
   URL: https://supabase.com/dashboard/project/okalizcwyzpwaffrkbey

2. **Enable Google Provider**
   - Authentication ‚Üí Providers ‚Üí Google
   - Toggle **Enable Sign in with Google**
   
3. **L·∫•y Redirect URL t·ª´ Supabase**
   - Copy callback URL: `https://<project-ref>.supabase.co/auth/v1/callback`
   - V√≠ d·ª•: `https://okalizcwyzpwaffrkbey.supabase.co/auth/v1/callback`

---

### Phase 2: Google Cloud Console Setup

> [!IMPORTANT]
> B·∫°n c·∫ßn Google Cloud Project ƒë·ªÉ t·∫°o OAuth credentials.

1. **T·∫°o Google Cloud Project** (n·∫øu ch∆∞a c√≥)
   - URL: https://console.cloud.google.com
   - Click "New Project" ‚Üí ƒê·∫∑t t√™n ‚Üí Create

2. **Enable Google+ API**
   - APIs & Services ‚Üí Library
   - Search "Google+ API" ‚Üí Enable

3. **T·∫°o OAuth Credentials**
   - APIs & Services ‚Üí Credentials
   - Click "Create Credentials" ‚Üí OAuth 2.0 Client ID
   - Application type: **Web application**
   - Name: `R4B OAuth`

4. **Configure Authorized URLs**
   
   **Authorized JavaScript origins:**
   ```
   http://localhost:8080
   http://localhost:5173
   ```

   **Authorized redirect URIs:**
   ```
   https://okalizcwyzpwaffrkbey.supabase.co/auth/v1/callback
   http://localhost:8080/auth/callback
   ```

5. **Save Credentials**
   - Copy **Client ID** v√† **Client Secret**

---

### Phase 3: Update Supabase v·ªõi Google Credentials

1. **Quay l·∫°i Supabase Dashboard**
   - Authentication ‚Üí Providers ‚Üí Google

2. **Paste Credentials**
   - Client ID: `<paste-your-client-id>.apps.googleusercontent.com`
   - Client Secret: `<paste-your-client-secret>`

3. **Save**

---

## üß™ Testing Guide

### Run Application

```powershell
# Terminal 1: Backend
cd server
npm start

# Terminal 2: Frontend
npm run dev
```

### Test Scenarios

#### ‚úÖ Scenario 1: First-time Google Login (Happy Path)

1. Navigate to `http://localhost:8080/auth`
2. Click **"Sign in with Google"** button
3. **Expected**: Redirect to Google consent screen
4. Select Google account
5. **Expected**: Redirect to `http://localhost:8080/auth/callback`
6. **Expected**: See "Login successful! Redirecting..." message
7. **Expected**: Auto-redirect to Shop page
8. **Verify**: User logged in, username displayed in header

#### ‚úÖ Scenario 2: Database Verification

Sau khi login th√†nh c√¥ng:

```sql
-- Ki·ªÉm tra trong Supabase Table Editor
SELECT * FROM users WHERE google_id IS NOT NULL;
```

**Expected fields:**
- `google_id`: c√≥ gi√° tr·ªã (Google User ID)
- `is_verified`: `true`
- `password`: `null`
- `email`: kh·ªõp v·ªõi Google account

#### ‚úÖ Scenario 3: Return User Login

1. Logout
2. Click "Sign in with Google" again
3. **Expected**: Google might skip consent (depends on account settings)
4. **Expected**: Faster redirect, same user data

#### ‚ùå Scenario 4: User Cancels OAuth

1. Click "Sign in with Google"
2. **Cancel** on Google consent screen
3. **Expected**: Redirect back to `/auth` with error message
4. **Verify**: No user created in database

#### ‚úÖ Scenario 5: Session Persistence

1. Login with Google
2. Refresh page
3. **Expected**: Still logged in
4. Close browser
5. Re-open `http://localhost:8080`
6. **Expected**: Still logged in (JWT valid for 7 days)

---

## üêõ Troubleshooting

### Issue: "Supabase anon client not configured"

**Fix:**  
Check frontend [.env.local](file:///c:/Users/Adonis/Downloads/App/.env.local):
```bash
VITE_SUPABASE_URL=https://okalizcwyzpwaffrkbey.supabase.co
VITE_SUPABASE_ANON_KEY=<your-anon-key>
```

### Issue: "Invalid session token" 

**Possible causes:**
- Google credentials ch∆∞a ƒë∆∞·ª£c config trong Supabase Dashboard
- Redirect URL kh√¥ng match trong Google Cloud Console

**Fix:**  
- Verify Google Client ID + Secret trong Supabase
- Double-check Authorized redirect URIs

### Issue: Database error "column google_id does not exist"

**Fix:**  
Run migration:
```bash
cd server
# Apply migration manually trong Supabase SQL Editor
```

---

## üìä Success Criteria

- [x] Backend routes ho·∫°t ƒë·ªông
- [x] Frontend components render correctly
- [ ] Google OAuth flow ho√†n th√†nh kh√¥ng l·ªói
- [ ] User ƒë∆∞·ª£c t·∫°o/update trong database v·ªõi `google_id`
- [ ] Auto-verify users (is_verified = true)
- [ ] Session persistence across refreshes
- [ ] Logout clears both JWT v√† Supabase session

---

## üìù Next Steps (Optional)

1. **Production deployment**:
   - Update authorized URLs trong Google Cloud Console v·ªõi production domain
   - Update [.env](file:///c:/Users/Adonis/Downloads/App/.env) v·ªõi production `CLIENT_URL`

2. **Enhanced features**:
   - Avatar sync t·ª´ Google profile picture
   - Display name override option
   - Link existing email/password account v·ªõi Google

3. **Security**:
   - Implement CSRF protection
   - Add rate limiting cho OAuth endpoints

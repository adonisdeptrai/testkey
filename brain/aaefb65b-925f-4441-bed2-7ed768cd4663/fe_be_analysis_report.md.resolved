# B√°o C√°o Ph√¢n T√≠ch Li√™n K·∫øt Frontend - Backend

**D·ª± √°n:** R4BBIT Shop  
**Ng√†y ph√¢n t√≠ch:** 2026-01-30  
**Phi√™n b·∫£n:** Sau Migration Supabase

---

## üìä T·ªïng Quan Ki·∫øn Tr√∫c

### Stack C√¥ng Ngh·ªá

| Layer | C√¥ng Ngh·ªá |
|-------|-----------|
| **Frontend** | React 18 + TypeScript + Vite |
| **Styling** | TailwindCSS + Framer Motion |
| **State** | React Context (Auth, Cart, Toast) |
| **Backend** | Express.js + Node.js |
| **Database** | Supabase (PostgreSQL) |
| **Auth** | Supabase Auth (OAuth + Email/Password) |
| **Routing** | react-router-dom v6 |

---

## üóÇÔ∏è C·∫•u Tr√∫c Project

### Backend (`/server`)

```
server/
‚îú‚îÄ‚îÄ index.js                    # Entry point, route registration
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ supabase.js            # Supabase client configuration
‚îú‚îÄ‚îÄ middleware/
‚îÇ   ‚îú‚îÄ‚îÄ auth.js                # Supabase token verification
‚îÇ   ‚îú‚îÄ‚îÄ adminAuth.js           # Admin role check
‚îÇ   ‚îî‚îÄ‚îÄ rateLimiter.js         # Rate limiting
‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îú‚îÄ‚îÄ auth.js                # Authentication (login, register, verify)
‚îÇ   ‚îú‚îÄ‚îÄ oauth.js               # Google OAuth callback
‚îÇ   ‚îú‚îÄ‚îÄ products.js            # Product CRUD
‚îÇ   ‚îú‚îÄ‚îÄ orders.js              # Order management
‚îÇ   ‚îú‚îÄ‚îÄ users.js               # User management (Admin)
‚îÇ   ‚îú‚îÄ‚îÄ settings.js            # System settings + TPBank/Binance
‚îÇ   ‚îú‚îÄ‚îÄ stats.js               # Dashboard statistics
‚îÇ   ‚îú‚îÄ‚îÄ balance.js             # Balance top-up & transactions
‚îÇ   ‚îú‚îÄ‚îÄ keys.js                # Product key management
‚îÇ   ‚îú‚îÄ‚îÄ tickets.js             # Support tickets
‚îÇ   ‚îú‚îÄ‚îÄ payment.js             # Binance Pay integration
‚îÇ   ‚îî‚îÄ‚îÄ upload.js              # File upload
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îú‚îÄ‚îÄ encryption.js          # AES encryption for sensitive data
‚îÇ   ‚îú‚îÄ‚îÄ tpbank.js              # TPBank API client
‚îÇ   ‚îú‚îÄ‚îÄ binance.js             # Binance API client
‚îÇ   ‚îî‚îÄ‚îÄ binancePay.js          # Binance Pay client
‚îî‚îÄ‚îÄ workers/
    ‚îî‚îÄ‚îÄ tpbankWorker.js        # Background job for bank verification
```

### Frontend (`/src`)

```
src/
‚îú‚îÄ‚îÄ App.tsx                    # Router configuration
‚îú‚îÄ‚îÄ types.ts                   # TypeScript type definitions
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îú‚îÄ‚îÄ api.ts                 # API endpoints configuration
‚îÇ   ‚îî‚îÄ‚îÄ supabase.ts            # Supabase client for OAuth
‚îú‚îÄ‚îÄ contexts/
‚îÇ   ‚îú‚îÄ‚îÄ AuthContext.tsx        # Authentication state
‚îÇ   ‚îú‚îÄ‚îÄ CartContext.tsx        # Shopping cart state
‚îÇ   ‚îî‚îÄ‚îÄ ToastContext.tsx       # Toast notifications
‚îú‚îÄ‚îÄ pages/
‚îÇ   ‚îú‚îÄ‚îÄ LandingPage.tsx        # Public landing
‚îÇ   ‚îú‚îÄ‚îÄ Auth.tsx               # Login/Register
‚îÇ   ‚îú‚îÄ‚îÄ AuthCallback.tsx       # OAuth callback handler
‚îÇ   ‚îú‚îÄ‚îÄ Shop.tsx               # Product listing
‚îÇ   ‚îú‚îÄ‚îÄ Checkout.tsx           # Payment flow
‚îÇ   ‚îú‚îÄ‚îÄ Dashboard.tsx          # User/Admin dashboard router
‚îÇ   ‚îú‚îÄ‚îÄ AdminDashboard.tsx     # Admin panel
‚îÇ   ‚îú‚îÄ‚îÄ UserDashboard.tsx      # User panel
‚îÇ   ‚îú‚îÄ‚îÄ VerifyEmail.tsx        # Email verification
‚îÇ   ‚îú‚îÄ‚îÄ ResetPassword.tsx      # Password reset
‚îÇ   ‚îî‚îÄ‚îÄ OrderSuccess.tsx       # Order confirmation
‚îî‚îÄ‚îÄ components/
    ‚îú‚îÄ‚îÄ admin/                 # Admin-specific components
    ‚îú‚îÄ‚îÄ common/                # Shared UI components
    ‚îú‚îÄ‚îÄ dashboard/             # Dashboard widgets
    ‚îú‚îÄ‚îÄ landing/               # Landing page sections
    ‚îî‚îÄ‚îÄ layout/                # Layout components
```

---

## üîó API Endpoints Mapping

### Authentication Routes (`/api/auth`)

| Method | Endpoint | FE Consumer | BE Handler | Status |
|--------|----------|-------------|------------|--------|
| POST | `/api/auth/register` | `AuthContext.register()` | `routes/auth.js` | ‚úÖ Ho·∫°t ƒë·ªông |
| POST | `/api/auth/login` | `AuthContext.login()` | `routes/auth.js` | ‚úÖ Ho·∫°t ƒë·ªông |
| POST | `/api/auth/logout` | `AuthContext.logout()` | `routes/auth.js` | ‚úÖ Ho·∫°t ƒë·ªông |
| GET | `/api/auth/verify-email/:token` | `VerifyEmail.tsx` | `routes/auth.js` | ‚úÖ Ho·∫°t ƒë·ªông |
| POST | `/api/auth/forgot-password` | `Auth.tsx` | `routes/auth.js` | ‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y handler |
| POST | `/api/auth/reset-password/:token` | `ResetPassword.tsx` | `routes/auth.js` | ‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y handler |
| POST | `/api/auth/verify` | `Auth.tsx` | `routes/auth.js` | ‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y handler |
| POST | `/api/auth/verify-payment` | `Checkout.tsx` | `routes/auth.js` | ‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y handler |
| POST | `/api/auth/refresh` | - | `routes/auth.js` | ‚úÖ Ho·∫°t ƒë·ªông |
| POST | `/api/auth/oauth/callback` | `AuthCallback.tsx` | `routes/oauth.js` | ‚ö†Ô∏è DEPRECATED |

### Products Routes (`/api/products`)

| Method | Endpoint | FE Consumer | BE Handler | Status |
|--------|----------|-------------|------------|--------|
| GET | `/api/products` | `Shop.tsx`, `AdminDashboard.tsx` | `routes/products.js` | ‚úÖ Public |
| GET | `/api/products/:id` | - | `routes/products.js` | ‚úÖ Public |
| POST | `/api/products` | `AdminDashboard.tsx`, `AddProduct.tsx` | `routes/products.js` | ‚úÖ Admin |
| PUT | `/api/products/:id` | `AdminDashboard.tsx` | `routes/products.js` | ‚úÖ Admin |
| DELETE | `/api/products/:id` | `AdminDashboard.tsx` | `routes/products.js` | ‚úÖ Admin |

### Orders Routes (`/api/orders`)

| Method | Endpoint | FE Consumer | BE Handler | Status |
|--------|----------|-------------|------------|--------|
| GET | `/api/orders` | `AdminDashboard.tsx` | `routes/orders.js` | ‚úÖ Admin |
| GET | `/api/orders/my-orders` | `UserDashboard.tsx` | `routes/orders.js` | ‚úÖ Protected |
| GET | `/api/orders/pending` | `AdminDashboard.tsx` | `routes/orders.js` | ‚úÖ Admin |
| POST | `/api/orders` | `Checkout.tsx` | `routes/orders.js` | ‚úÖ Public |
| PUT | `/api/orders/:id` | `AdminDashboard.tsx` | `routes/orders.js` | ‚úÖ Admin |
| PUT | `/api/orders/:id/verify` | `AdminDashboard.tsx` | `routes/orders.js` | ‚úÖ Admin |
| POST | `/api/orders/checkout-with-balance` | - | `routes/orders.js` | ‚úÖ Protected |

### Users Routes (`/api/users`)

| Method | Endpoint | FE Consumer | BE Handler | Status |
|--------|----------|-------------|------------|--------|
| GET | `/api/users` | `AdminDashboard.tsx` | `routes/users.js` | ‚úÖ Admin |
| PUT | `/api/users/:id` | - | `routes/users.js` | ‚úÖ Admin |
| PUT | `/api/users/:id/ban` | - | `routes/users.js` | ‚úÖ Admin |
| PUT | `/api/users/:id/balance` | - | `routes/users.js` | ‚úÖ Admin |
| DELETE | `/api/users/:id` | - | `routes/users.js` | ‚úÖ Admin |

### Settings Routes (`/api/settings`)

| Method | Endpoint | FE Consumer | BE Handler | Status |
|--------|----------|-------------|------------|--------|
| GET | `/api/settings` | `Checkout.tsx`, `AdminDashboard.tsx` | `routes/settings.js` | ‚úÖ Public |
| PUT | `/api/settings` | `AdminDashboard.tsx` | `routes/settings.js` | ‚úÖ Admin |
| POST | `/api/settings/test-tpbank` | `AdminDashboard.tsx` | `routes/settings.js` | ‚úÖ Admin |
| POST | `/api/settings/tpbank-history` | `TPBankMonitor.tsx` | `routes/settings.js` | ‚úÖ Admin |
| GET | `/api/settings/tpbank-logs` | - | `routes/settings.js` | ‚ö†Ô∏è Defined in api.ts, no handler |
| POST | `/api/settings/test-binance` | `AdminDashboard.tsx` | `routes/settings.js` | ‚úÖ Admin |
| POST | `/api/settings/binance-fee` | - | `routes/settings.js` | ‚úÖ Public |
| POST | `/api/settings/binance-qr` | - | `routes/settings.js` | ‚úÖ Public |
| POST | `/api/settings/binance-history` | `BinanceMonitor.tsx` | `routes/settings.js` | ‚úÖ Admin |

### Payment Routes (`/api/payment`)

| Method | Endpoint | FE Consumer | BE Handler | Status |
|--------|----------|-------------|------------|--------|
| POST | `/api/payment/binance/create` | `Checkout.tsx` | `routes/payment.js` | ‚úÖ Protected |
| GET | `/api/payment/binance/query/:orderId` | `Checkout.tsx` | `routes/payment.js` | ‚úÖ Protected |

### Balance Routes (`/api/balance`)

| Method | Endpoint | FE Consumer | BE Handler | Status |
|--------|----------|-------------|------------|--------|
| GET | `/api/balance/my-balance` | - | `routes/balance.js` | ‚úÖ Protected |
| POST | `/api/balance/topup` | - | `routes/balance.js` | ‚úÖ Protected |
| GET | `/api/balance/transactions` | - | `routes/balance.js` | ‚úÖ Protected |
| POST | `/api/balance/adjust` | - | `routes/balance.js` | ‚úÖ Admin |

### Keys Routes (`/api/keys`)

| Method | Endpoint | FE Consumer | BE Handler | Status |
|--------|----------|-------------|------------|--------|
| GET | `/api/keys` | - | `routes/keys.js` | ‚úÖ Admin |
| POST | `/api/keys` | - | `routes/keys.js` | ‚úÖ Admin |
| DELETE | `/api/keys/:id` | - | `routes/keys.js` | ‚úÖ Admin |
| GET | `/api/keys/assigned/:orderId` | - | `routes/keys.js` | ‚úÖ Protected |
| POST | `/api/keys/assign` | - | `routes/keys.js` | ‚úÖ Admin |

### Tickets Routes (`/api/tickets`)

| Method | Endpoint | FE Consumer | BE Handler | Status |
|--------|----------|-------------|------------|--------|
| GET | `/api/tickets/my-tickets` | - | `routes/tickets.js` | ‚úÖ Protected |
| POST | `/api/tickets` | - | `routes/tickets.js` | ‚úÖ Protected |
| GET | `/api/tickets/:id` | - | `routes/tickets.js` | ‚úÖ Protected |
| POST | `/api/tickets/:id/reply` | - | `routes/tickets.js` | ‚úÖ Protected |
| PUT | `/api/tickets/:id/status` | - | `routes/tickets.js` | ‚úÖ Admin |
| PUT | `/api/tickets/:id/priority` | - | `routes/tickets.js` | ‚úÖ Admin |
| POST | `/api/tickets/:id/assign` | - | `routes/tickets.js` | ‚úÖ Admin |
| DELETE | `/api/tickets/:id` | - | `routes/tickets.js` | ‚úÖ Admin |
| GET | `/api/tickets` (all) | - | `routes/tickets.js` | ‚úÖ Admin |

### Stats Routes (`/api/stats`)

| Method | Endpoint | FE Consumer | BE Handler | Status |
|--------|----------|-------------|------------|--------|
| GET | `/api/stats/overview` | `AdminDashboard.tsx` | `routes/stats.js` | ‚úÖ Admin |

### Upload Routes (`/api/upload`)

| Method | Endpoint | FE Consumer | BE Handler | Status |
|--------|----------|-------------|------------|--------|
| POST | `/api/upload` | `AdminDashboard.tsx` | `routes/upload.js` | ‚úÖ Admin |

---

## ‚ö†Ô∏è V·∫•n ƒê·ªÅ Ph√°t Hi·ªán

### 1. Hardcoded API URLs

> [!CAUTION]
> Nhi·ªÅu file FE ƒëang s·ª≠ d·ª•ng hardcoded `http://localhost:5000` thay v√¨ d√πng `API_ENDPOINTS` t·ª´ config.

**Files b·ªã ·∫£nh h∆∞·ªüng:**

| File | S·ªë l∆∞·ª£ng hardcoded URLs |
|------|-------------------------|
| [AdminDashboard.tsx](file:///c:/Users/Adonis/Downloads/App/src/pages/AdminDashboard.tsx) | 12 URLs |
| [Checkout.tsx](file:///c:/Users/Adonis/Downloads/App/src/pages/Checkout.tsx) | 5 URLs |
| [UserDashboard.tsx](file:///c:/Users/Adonis/Downloads/App/src/pages/UserDashboard.tsx) | 2 URLs |
| [Shop.tsx](file:///c:/Users/Adonis/Downloads/App/src/pages/Shop.tsx) | 1 URL |
| [Auth.tsx](file:///c:/Users/Adonis/Downloads/App/src/pages/Auth.tsx) | 1 URL |
| [AddProduct.tsx](file:///c:/Users/Adonis/Downloads/App/src/pages/Admin/AddProduct.tsx) | 1 URL |

**Khuy·∫øn ngh·ªã:** Thay th·∫ø t·∫•t c·∫£ hardcoded URLs b·∫±ng `API_ENDPOINTS` ho·∫∑c `API_BASE_URL` t·ª´ `src/config/api.ts`.

---

### 2. Missing API Handlers

> [!WARNING]
> M·ªôt s·ªë endpoints ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a trong FE nh∆∞ng kh√¥ng c√≥ handler t∆∞∆°ng ·ª©ng trong BE.

| Endpoint | Defined In | Missing Handler |
|----------|------------|-----------------|
| `POST /api/auth/forgot-password` | `api.ts`, `Auth.tsx` | ‚ùå Kh√¥ng t√¨m th·∫•y trong `routes/auth.js` |
| `POST /api/auth/reset-password/:token` | `api.ts`, `ResetPassword.tsx` | ‚ùå Kh√¥ng t√¨m th·∫•y trong `routes/auth.js` |
| `POST /api/auth/verify` | `Auth.tsx` | ‚ùå Kh√¥ng t√¨m th·∫•y trong `routes/auth.js` |
| `POST /api/auth/verify-payment` | `api.ts`, `Checkout.tsx` | ‚ùå Kh√¥ng t√¨m th·∫•y trong `routes/auth.js` |
| `GET /api/settings/tpbank-logs` | `api.ts` | ‚ùå Kh√¥ng t√¨m th·∫•y trong `routes/settings.js` |
| `PUT /api/orders/:id/manual-verify` | `api.ts` | ‚ùå Kh√¥ng t√¨m th·∫•y trong `routes/orders.js` |

---

### 3. Unused API Endpoints (BE c√≥, FE kh√¥ng d√πng)

| Endpoint | BE Handler | Ghi ch√∫ |
|----------|------------|---------|
| `/api/balance/*` | `routes/balance.js` | FE ch∆∞a integrate UI |
| `/api/keys/*` | `routes/keys.js` | FE ch∆∞a integrate UI |
| `/api/tickets/*` | `routes/tickets.js` | FE ch∆∞a integrate UI |
| `/api/orders/checkout-with-balance` | `routes/orders.js` | Balance payment flow ch∆∞a implement |

---

### 4. Authentication Flow Issues

> [!IMPORTANT]
> FE ƒëang s·ª≠ d·ª•ng **hybrid approach** cho authentication:
> - **Supabase Client** (frontend): D√πng cho OAuth v√† session management
> - **Backend API**: D√πng cho m·ªôt s·ªë verify endpoints

**V·∫•n ƒë·ªÅ ti·ªÅm ·∫©n:**
1. `Auth.tsx` g·ªçi `/api/auth/verify` v·ªõi hardcoded URL nh∆∞ng handler kh√¥ng t·ªìn t·∫°i
2. `AuthContext.tsx` login th√¥ng qua `supabase.auth.signInWithPassword()` nh∆∞ng kh√¥ng sync v·ªõi backend session
3. M·ªôt s·ªë backend routes y√™u c·∫ßu Supabase token trong header nh∆∞ng FE kh√¥ng nh·∫•t qu√°n trong vi·ªác g·ª≠i token

---

### 5. CORS v√† Security

‚úÖ **ƒê√£ c·∫•u h√¨nh:**
- Helmet security headers
- Rate limiting (`apiLimiter`)
- CORS enabled

‚ö†Ô∏è **C·∫ßn ki·ªÉm tra:**
- CORS origin kh√¥ng ƒë∆∞·ª£c restrict, c√≥ th·ªÉ g√¢y security risk trong production

---

## üì¶ Database Schema (Supabase)

Migrations ƒë√£ ƒë∆∞·ª£c √°p d·ª•ng:

| Order | Migration | Description |
|-------|-----------|-------------|
| 001 | [create_users_table.sql](file:///c:/Users/Adonis/Downloads/App/server/supabase/migrations/001_create_users_table.sql) | Users table |
| 002 | [create_products_table.sql](file:///c:/Users/Adonis/Downloads/App/server/supabase/migrations/002_create_products_table.sql) | Products table |
| 003 | [create_product_keys_table.sql](file:///c:/Users/Adonis/Downloads/App/server/supabase/migrations/003_create_product_keys_table.sql) | Product keys |
| 004 | [create_orders_table.sql](file:///c:/Users/Adonis/Downloads/App/server/supabase/migrations/004_create_orders_table.sql) | Orders table |
| 005 | [create_transactions_table.sql](file:///c:/Users/Adonis/Downloads/App/server/supabase/migrations/005_create_transactions_table.sql) | Transactions |
| 006 | [create_tickets_table.sql](file:///c:/Users/Adonis/Downloads/App/server/supabase/migrations/006_create_tickets_table.sql) | Support tickets |
| 007 | [create_settings_table.sql](file:///c:/Users/Adonis/Downloads/App/server/supabase/migrations/007_create_settings_table.sql) | System settings |
| 008 | [create_system_logs_table.sql](file:///c:/Users/Adonis/Downloads/App/server/supabase/migrations/008_create_system_logs_table.sql) | System logs |
| 009 | [add_foreign_key_constraints.sql](file:///c:/Users/Adonis/Downloads/App/server/supabase/migrations/009_add_foreign_key_constraints.sql) | FK constraints |
| 010 | [add_google_oauth_support.sql](file:///c:/Users/Adonis/Downloads/App/server/supabase/migrations/010_add_google_oauth_support.sql) | OAuth support |

---

## üîê Authentication Architecture

```mermaid
sequenceDiagram
    participant User
    participant FE as Frontend
    participant Supabase as Supabase Auth
    participant BE as Backend API
    participant DB as PostgreSQL

    %% Login Flow
    User->>FE: Enter credentials
    FE->>Supabase: signInWithPassword()
    Supabase-->>FE: Session + Access Token
    FE->>FE: Store session in localStorage
    
    %% Protected API Call
    User->>FE: Access protected resource
    FE->>BE: API Request + Bearer Token
    BE->>Supabase: getUser(token)
    Supabase-->>BE: User object
    BE->>DB: Query public.users
    DB-->>BE: User data
    BE-->>FE: Protected resource
```

---

## ‚úÖ Recommendations

### ∆Øu ti√™n cao

1. **Fix Missing Handlers**: Implement c√°c API handlers c√≤n thi·∫øu ho·∫∑c remove endpoints kh√¥ng s·ª≠ d·ª•ng
2. **Refactor Hardcoded URLs**: S·ª≠ d·ª•ng `API_ENDPOINTS` t·ª´ config thay v√¨ hardcode
3. **Implement Balance/Keys/Tickets UI**: FE c·∫ßn UI cho c√°c features ƒë√£ c√≥ backend

### ∆Øu ti√™n trung b√¨nh

4. **Add CORS Origin Restriction**: Gi·ªõi h·∫°n allowed origins trong production
5. **Implement Error Boundary**: Th√™m error handling cho API failures
6. **Add API Response Types**: T·∫°o TypeScript types cho API responses

### ∆Øu ti√™n th·∫•p

7. **Cleanup Deprecated OAuth**: Remove legacy `/api/auth/oauth/callback`
8. **Add API Documentation**: Generate OpenAPI/Swagger docs
9. **Implement Request Caching**: Add SWR ho·∫∑c React Query

---

## üìà Statistics

| Metric | Count |
|--------|-------|
| Total BE Routes | 12 files |
| Total API Endpoints | ~50+ |
| FE Pages | 12 |
| FE Components | 19 |
| Missing Handlers | 6 |
| Hardcoded URLs | 22 |
| DB Tables | 8+ |

---

> **T·∫°o b·ªüi:** Gemini AI Analysis  
> **Th·ªùi gian:** 2026-01-30T12:29:41+07:00

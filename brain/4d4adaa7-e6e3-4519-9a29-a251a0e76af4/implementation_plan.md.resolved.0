# Payment Verification Admin Interface - Implementation Plan

## Goal

Táº¡o giao diá»‡n admin Ä‘á»ƒ kiá»ƒm tra vÃ  xÃ¡c minh payment manual khi user chuyá»ƒn sai sá»‘ tiá»n hoáº·c quÃªn ghi mÃ£ Ä‘Æ¡n hÃ ng, giÃºp admin há»— trá»£ user má»™t cÃ¡ch hiá»‡u quáº£.

## User Review Required

> [!IMPORTANT]
> **TÃ­nh nÄƒng má»›i: Manual Payment Verification**
> 
> Admin sáº½ cÃ³ kháº£ nÄƒng:
> - Xem táº¥t cáº£ pending orders vÃ  transactions chÆ°a match
> - So sÃ¡nh side-by-side: Expected vs Received
> - Manual verify khi user chuyá»ƒn sai sá»‘ tiá»n hoáº·c thiáº¿u mÃ£
> - Xem audit log Ä‘áº§y Ä‘á»§ má»i verification actions

> [!WARNING]
> **Breaking Changes**
> 
> Backend sáº½ thÃªm endpoint má»›i cho manual verification. Cáº§n JWT admin token.

## Proposed Changes

### Backend Changes

#### [NEW] [routes/orders.js](file:///c:/Users/Adonis/Downloads/App/server/routes/orders.js)

**New API endpoints:**

```javascript
// GET /api/orders/pending
// List all pending orders with bank transfer method
router.get('/pending', auth, adminAuth, async (req, res) => {
  // Return orders with status in ['Pending', 'Pending Verification']
  // Filter by paymentMethod='bank_transfer'
});

// POST /api/orders/:orderId/manual-verify
// Manually verify a payment (admin override)
router.post('/:orderId/manual-verify', auth, adminAuth, async (req, res) => {
  const { transactionId, note } = req.body;
  // Update order status to 'Completed'
  // Set verifiedAt timestamp
  // Log to SystemLog with note
  // Return updated order
});
```

**Purpose:** Cho phÃ©p admin list pending orders vÃ  manual verify khi cáº§n.

---

### Frontend Changes

#### [MODIFY] [TPBankMonitor.tsx](file:///c:/Users/Adonis/Downloads/App/src/components/admin/TPBankMonitor.tsx)

**ThÃªm tab má»›i:'verification'**

```typescript
// Line ~17: Add new tab
const [activeTab, setActiveTab] = useState<'dashboard' | 'verification' | 'raw' | 'logs'>('dashboard');

// Line ~158-176: Add verification to tabs array
{ id: 'dashboard', label: 'Dashboard', icon: Layout },
{ id: 'verification', label: 'Verify Payments', icon: Search }, // NEW
{ id: 'raw', label: 'Raw Data', icon: Database },
{ id: 'logs', label: 'System Logs', icon: Terminal },
```

**ThÃªm Verification View má»›i** (sau line ~309):

```typescript
{/* VERIFICATION VIEW */}
{activeTab === 'verification' && (
  <PaymentVerificationView orders={orders} history={history} />
)}
```

#### [NEW] [PaymentVerificationView.tsx](file:///c:/Users/Adonis/Downloads/App/src/components/admin/PaymentVerificationView.tsx)

**Component structure:**

```typescript
interface PaymentVerificationViewProps {
  orders: Order[];
  history: any[];
}

const PaymentVerificationView = ({ orders, history }) => {
  // State
  const [pendingOrders, setPendingOrders] = useState([]);
  const [searchCode, setSearchCode] = useState('');
  const [selectedOrder, setSelectedOrder] = useState(null);
  const [showManualVerifyModal, setShowManualVerifyModal] = useState(false);
  
  // Fetch pending orders tá»« API
  // Search and filter logic
  // Matching logic (phÃ¡t hiá»‡n partial matches)
  
  return (
    <div className="space-y-6">
      {/* Search Box */}
      <input placeholder="Search by order code..." />
      
      {/* Pending Orders Table */}
      <table>
        {/* Columns: Order ID, Amount, Status, Actions */}
        {/* Show "Partial Match" badge if cÃ³ transaction match order code nhÆ°ng sai sá»‘  */}
      </table>
      
      {/* Transaction Comparison Modal */}
      {selectedOrder && (
        <ComparisonModal
          order={selectedOrder}
          matchingTransactions={findMatches(selectedOrder)}
          onManualVerify={handleManualVerify}
        />
      )}
    </div>
 );
};
```

**Features:**

1. **Search by Order Code**: Input Ä‘á»ƒ search theo mÃ£ Ä‘Æ¡n
2. **Pending Orders List**: Table hiá»ƒn thá»‹ táº¥t cáº£ pending bank orders
3. **Status Indicators**:
   - âœ… **Exact Match**: Green - Sá»‘ tiá»n vÃ  mÃ£ Ä‘á»u Ä‘Ãºng
   - âš ï¸ **Partial Match**: Yellow - CÃ³ mÃ£ nhÆ°ng sai sá»‘ tiá»n
   - âŒ **No Match**: Red - KhÃ´ng tÃ¬m tháº¥y transaction nÃ o
4. **Comparison View**: Modal so sÃ¡nh Expected vs Received
5. **Manual Verify Button**: Cho phÃ©p admin override verification

#### [NEW] [ComparisonModal.tsx](file:///c:/Users/Adonis/Downloads/App/src/components/admin/ComparisonModal.tsx)

**Modal UI:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Payment Verification              
â”‚                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Order Details          â”‚ Transactionâ”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Order: ORD-1234       â”‚ Found 1 tx â”‚
â”‚ Expected: 2500 VND    â”‚ Recv: 2000 â”‚
â”‚ Code: ORD-1234        â”‚ Desc: ORD  â”‚
â”‚                       â”‚ -1234      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âŒ Amount Mismatch: -500 VND        â”‚
â”‚ âœ… Order code present              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Reason/Note:                        â”‚
â”‚ [textarea for admin note]           â”‚
â”‚                                     â”‚
â”‚ [Cancel] [Manual Verify & Complete]â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Verification Plan

### Automated Tests

> [!CAUTION]
> **No existing automated tests found.** Project chÆ°a cÃ³ test suite.

Sáº½ verify manually qua browser.

### Manual Verification

#### Test Case 1: View Pending Orders
1. Login as admin (`mquyendeptrai` / `mquyendeptrai`)
2. Navigate to Admin Dashboard â†’ Transfer History â†’ **Verify Payments** tab  
3. **Expected**: Hiá»ƒn thá»‹ list pending bank transfer orders
4. **Check**: Table cÃ³ columns: Order ID, Amount, Status, Actions

#### Test Case 2: Search by Order Code
1. Trong Verify Payments tab, type order code vÃ o search box
2. **Expected**: Filter results real-time
3. **Check**: Chá»‰ hiá»ƒn thá»‹ orders match search term

#### Test Case 3: Detect Partial Match
1. Táº¡o order má»›i 2500 VND (e.g. ORD-5678)
2. User chuyá»ƒn 2000 VND vá»›i description "R4B ORD-5678"
3. Wait 60s Ä‘á»ƒ worker check
4. Refresh Verify Payments tab
5. **Expected**: Order hiá»ƒn thá»‹ vá»›i badge "âš ï¸ Partial Match - Amount Mismatch"
6. **Check**: Click "View" Ä‘á»ƒ xem comparison

#### Test Case 4: Manual Verification
1. Click "View" trÃªn partial match order
2. **Expected**: Modal hiá»ƒn thá»‹:
   - Left: Order details (Expected amount, code)
   - Right: Transaction details (Received amount, description)
   - Difference highlighted
3. Input reason: "User chuyá»ƒn thiáº¿u 500 VND, Ä‘Ã£ confirm qua Messenger"
4. Click "Manual Verify & Complete"
5. **Expected**:
   - Order status â†’ "Completed"
   - Modal close
   - Order biáº¿n máº¥t khá»i pending list
6. **Check System Logs**: Should see SUCCESS log vá»›i note

#### Test Case 5: No Match Scenario
1. Táº¡o order má»›i nhÆ°ng user KHÃ”NG chuyá»ƒn tiá»n
2. Wait > 60s
3. **Expected**: Order váº«n á»Ÿ trong pending list
4. **Expected**: KhÃ´ng cÃ³ partial match badge
5. **Check**: Click "View" â†’ "No matching transactions found"

#### Test Case 6: Exact Match (Auto Verification)
1. Táº¡o order 3000 VND vá»›i code ORD-9999
2. User chuyá»ƒn ÄÃšNG 3000 VND vá»›i description "R4B ORD-9999"
3. Wait 60s
4. **Expected**: Order tá»± Ä‘á»™ng verify, KHÃ”NG xuáº¥t hiá»‡n trong Verify Payments tab
5. **Check Dashboard tab**: Order hiá»ƒn thá»‹ trong "Cleaned Data (Matched Orders)"

---

## UI/UX Mockup

### Verification Tab Layout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ðŸ” Search: [_________________] [Filter â–¼]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Order ID   â”‚ Amount  â”‚ Status        â”‚ Actionâ”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ORD-1234   â”‚ 2500    â”‚ âš ï¸ Partial   â”‚ [View]â”‚
â”‚ ORD-5678   â”‚ 1000    â”‚ âŒ No Match  â”‚ [View]â”‚
â”‚ ORD-9012   â”‚ 5000    â”‚ ðŸ• Pending   â”‚ [View]â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Status Badge Colors:**
- ðŸ• **Pending**: Gray (no transaction yet)
- âš ï¸ **Partial Match**: Yellow/Amber (has code, wrong amount)
- âœ… **Exact Match**: Green (shouldn't appear here, auto-verified)
- âŒ **No Match**: Red (no code found in transactions)

---

## Security Considerations

> [!WARNING]
> **Admin Only Feature**
> 
> - All endpoints require JWT + Admin role
> - Manual verification actions Ä‘Æ°á»£c log Ä‘áº§y Ä‘á»§ vÃ o SystemLog
> - Include admin username vÃ  reason trong log entry

**Audit Log Format:**
```javascript
{
  type: 'MANUAL_VERIFY',
  message: 'Admin manually verified Order ORD-1234',
  details: {
    orderId: 'ORD-1234',
    adminUser: 'mquyendeptrai',
    note: 'User chuyá»ƒn thiáº¿u, confirmed via chat',
    expectedAmount: 2500,
    receivedAmount: 2000,
    transactionId: 'xxx'
  }
}
```

---

## File Summary

| File | Type | Purpose |
|------|------|---------|
| [server/routes/orders.js](file:///c:/Users/Adonis/Downloads/App/server/routes/orders.js) | NEW | API endpoints cho pending orders & manual verify |
| [src/components/admin/TPBankMonitor.tsx](file:///c:/Users/Adonis/Downloads/App/src/components/admin/TPBankMonitor.tsx) | MODIFY | ThÃªm verification tab |
| `src/components/admin/PaymentVerificationView.tsx` | NEW | Main verification interface |
| `src/components/admin/ComparisonModal.tsx` | NEW | Modal so sÃ¡nh order vs transaction |

---

## Next Steps After Approval

1. âœ… Implement backend API endpoints
2. âœ… Create PaymentVerificationView component
3. âœ… Create ComparisonModal component
4. âœ… Integrate into TPBankMonitor
5. âœ… Manual testing vá»›i táº¥t cáº£ test cases
6. âœ… Rebuild Docker
7. âœ… Create walkthrough documentation

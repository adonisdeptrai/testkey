# UI Fixes & Anti-Spam - Implementation Plan

## Issues Reported

1. ❌ Countdown timer updates every 10s instead of every 1s
2. ❌ No anti-spam mechanism for order creation  
3. ⚠️ Orders & Payments tab not working? (Need confirmation)
4. ❌ Admin dashboard cannot scroll

## Issue Analysis

### 1. Count down Timer - [Checkout.tsx](file:///c:/Users/Adonis/Downloads/App/src/pages/Checkout.tsx)

**Location:** "Waiting for Payment" screen (Bank Transfer flow)

**Current Behavior:**
```typescript
const MAX_DURATION = 15 * 60 * 1000; // 15 minutes
// Timer likely displays but doesn't update per second
```

**Problem:** Timer calculation but no real-time UI update state

**Solution:**
- Add `remainingTime` state
- Use `setInterval` with 1000ms (1s) interval
- Update display every second
- Clear interval on unmount/completion

### 2. Anti-Spam for Orders - Backend

**Endpoint:** `POST /api/orders`

**Current:** No rate limiting

**Solution:**
- Track order creation attempts per user
- Limit: 1 order per 30 seconds
- Use in-memory Map or Redis for tracking
- Return 429 error when limit exceeded

**Implementation:**
```javascript
const orderAttempts = new Map(); // userId -> timestamp

// Middleware
function rateLimitOrders(req, res, next) {
  const userId = req.user?.id;
  const now = Date.now();
  const lastAttempt = orderAttempts.get(userId);
  
  if (lastAttempt && (now - lastAttempt) < 30000) {
    return res.status(429).json({ 
      message: 'Too many orders. Please wait 30 seconds.' 
    });
  }
  
  orderAttempts.set(userId, now);
  next();
}
```

### 3. Orders & Payments Tab

**Current Status:**
- Tab exists in Dashboard navigation (line 124)
- Maps to [AdminOrders](file:///c:/Users/Adonis/Downloads/App/src/pages/AdminDashboard.tsx#272-317) component (line 1546)
- Component is defined and should work

**Possible Issues:**
- API errors (check `/api/orders` endpoint)
- Empty orders array (no data to display)
- Component rendering issue

**Action:** Test and verify, may already be working

### 4. Admin Dashboard Scroll

**Location:** [AdminDashboard.tsx](file:///c:/Users/Adonis/Downloads/App/src/pages/AdminDashboard.tsx)

**Issue:** Cannot scroll on long content

**Potential Causes:**
- Line 1291: `<main className="flex-1 min-w-0 overflow-auto">` - Should be OK
- Line 1459: `<div className="w-full h-full">` - `h-full` may prevent scroll
- Parent Dashboard wrapper constraints

**Solution:**
- Change `h-full` to `min-h-full`
- Ensure no `overflow-hidden` on parent
- Add explicit `overflow-y-auto` if needed

---

## Proposed Changes

### Frontend

#### [MODIFY] [Checkout.tsx](file:///c:/Users/Adonis/Downloads/App/src/pages/Checkout.tsx)

Add real-time countdown display:

```typescript
// Add state
const [remainingTime, setRemainingTime] = useState<number>(15 * 60); // seconds

// Add effect
useEffect(() => {
  if (paymentStep !== 'waiting') return;
  
  const interval = setInterval(() => {
    setRemainingTime(prev => {
      if (prev <= 0) {
        clearInterval(interval);
        return 0;
      }
      return prev - 1;
    });
  }, 1000);
  
  return () => clearInterval(interval);
}, [paymentStep]);

// Display
const minutes = Math.floor(remainingTime / 60);
const seconds = remainingTime % 60;
// Show: {minutes}:{seconds.toString().padStart(2, '0')}
```

#### [MODIFY] [AdminDashboard.tsx](file:///c:/Users/Adonis/Downloads/App/src/pages/AdminDashboard.tsx)

Fix scroll issue (line 1459):

```typescript
// Change from:
<div className="w-full h-full">

// To:
<div className="w-full">
```

---

### Backend

#### [MODIFY] [routes/orders.js](file:///c:/Users/Adonis/Downloads/App/server/routes/orders.js)

Add anti-spam middleware:

```javascript
// At top of file
const orderAttempts = new Map();

// Cleanup old entries every 5 minutes
setInterval(() => {
  const now = Date.now();
  for (const [userId, timestamp] of orderAttempts.entries()) {
    if (now - timestamp > 60000) { // 1 minute
      orderAttempts.delete(userId);
    }
  }
}, 300000);

// Middleware
const rateLimitOrders = (req, res, next) => {
  const userId = req.user?.id || req.body.user;
  if (!userId) return next();
  
  const now = Date.now();
  const lastAttempt = orderAttempts.get(userId);
  
  if (lastAttempt && (now - lastAttempt) < 30000) {
    const waitTime = Math.ceil((30000 - (now - lastAttempt)) / 1000);
    return res.status(429).json({ 
      message: `Please wait ${waitTime} seconds before creating another order.` 
    });
  }
  
  orderAttempts.set(userId, now);
  next();
};

// Apply to POST /api/orders
router.post('/', rateLimitOrders, async (req, res) => {
  // ... existing code
});
```

---

## Testing Plan

### Test 1: Countdown Timer
1. Go to Checkout with bank transfer
2. Create order → Waiting screen
3. **Verify:** Timer updates every second (not every 10s)
4. **Verify:** Format: "14:59" → "14:58" → "14:57"

### Test 2: Anti-Spam
1. Create order → Success
2. Immediately try to create another order (< 30s)
3. **Expected:** Error "Please wait X seconds"
4. Wait 30s, try again
5. **Expected:** Success

### Test 3: Orders & Payments Tab
1. Login as admin
2. Navigate to "Orders & Payments"
3. **Verify:** Table displays orders
4. **Verify:** Can click Verify button

### Test 4: Admin Scroll
1. Login as admin
2. Go to any tab with long content (Products, Orders)
3. **Verify:** Can scroll down to see all content
4. **Verify:** No content cut off

---

## Deployment

- Rebuild Docker: `docker-compose up -d --build`
- Test all 4 fixes
- Update walkthrough with results
